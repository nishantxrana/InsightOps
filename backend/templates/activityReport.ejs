<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DevOps Activity Report</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      color: #1e293b; 
      line-height: 1.5;
      font-size: 11pt;
    }
    
    .page { 
      page-break-after: always; 
      padding: 50px 60px;
      min-height: 100vh;
    }
    .page:last-child { page-break-after: auto; }
    
    /* Cover Page */
    .cover { 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      text-align: center;
      padding: 100px 60px;
    }
    .cover h1 { 
      font-size: 42pt; 
      font-weight: 700; 
      margin-bottom: 30px;
      color: #0f172a;
    }
    .cover .date-range { 
      font-size: 18pt; 
      color: #3b82f6; 
      font-weight: 600;
      margin-bottom: 60px;
      padding: 12px 24px;
      border: 2px solid #3b82f6;
      border-radius: 8px;
      display: inline-block;
    }
    .cover .metadata { 
      font-size: 12pt; 
      color: #64748b; 
      line-height: 1.8;
    }
    .cover .footer { 
      position: absolute; 
      bottom: 40px; 
      font-size: 10pt; 
      color: #94a3b8;
    }
    
    /* Executive Summary */
    .summary-header {
      font-size: 22pt;
      font-weight: 700;
      margin-bottom: 30px;
      color: #0f172a;
      border-bottom: 3px solid #e2e8f0;
      padding-bottom: 12px;
    }
    
    .health-score {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
    }
    .health-score-value {
      font-size: 48pt;
      font-weight: 700;
      color: #16a34a;
    }
    .health-score-label {
      font-size: 12pt;
      color: #64748b;
      margin-top: 8px;
    }
    
    .highlights, .concerns {
      margin: 25px 0;
    }
    .highlights h3, .concerns h3 {
      font-size: 14pt;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .highlights h3 { color: #16a34a; }
    .concerns h3 { color: #dc2626; }
    
    .highlights ul, .concerns ul {
      list-style: none;
      padding: 0;
    }
    .highlights li, .concerns li {
      padding: 8px 0 8px 28px;
      position: relative;
      font-size: 11pt;
      line-height: 1.6;
    }
    .highlights li:before {
      content: "âœ“";
      position: absolute;
      left: 0;
      color: #16a34a;
      font-weight: bold;
      font-size: 14pt;
    }
    .concerns li:before {
      content: "âš ";
      position: absolute;
      left: 0;
      font-size: 14pt;
    }
    
    /* Section Pages */
    .section-header {
      font-size: 20pt;
      font-weight: 700;
      margin-bottom: 25px;
      color: #0f172a;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 10px;
    }
    
    .section-layout {
      display: flex;
      gap: 30px;
      margin-bottom: 30px;
    }
    .section-main {
      flex: 2;
    }
    .section-chart {
      flex: 1;
      text-align: center;
    }
    .section-chart img {
      max-width: 100%;
      height: auto;
      max-height: 280px;
    }
    
    /* Metrics Table */
    .metrics-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .metrics-table th {
      background: #f1f5f9;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 10pt;
      color: #475569;
      border: 1px solid #e2e8f0;
    }
    .metrics-table td {
      padding: 12px;
      border: 1px solid #e2e8f0;
      font-size: 11pt;
    }
    .metrics-table .metric-value {
      font-size: 18pt;
      font-weight: 700;
    }
    
    /* Insights Block */
    .insights {
      background: #f8fafc;
      padding: 20px;
      border-radius: 6px;
      border-left: 4px solid #3b82f6;
      margin-top: 20px;
    }
    .insights h4 {
      font-size: 12pt;
      font-weight: 600;
      margin-bottom: 12px;
      color: #0f172a;
    }
    .insights ul {
      list-style: none;
      padding: 0;
    }
    .insights li {
      padding: 6px 0 6px 20px;
      position: relative;
      font-size: 10pt;
      line-height: 1.6;
      color: #475569;
    }
    .insights li:before {
      content: "â†’";
      position: absolute;
      left: 0;
      color: #3b82f6;
      font-weight: bold;
    }
    
    /* Semantic Colors */
    .success { color: #16a34a; }
    .danger { color: #dc2626; }
    .warning { color: #f97316; }
    .info { color: #3b82f6; }
    .neutral { color: #64748b; }
    
    /* Metadata Page */
    .metadata-section {
      margin-bottom: 30px;
    }
    .metadata-section h3 {
      font-size: 14pt;
      font-weight: 600;
      margin-bottom: 12px;
      color: #0f172a;
    }
    .metadata-list {
      list-style: none;
      padding: 0;
    }
    .metadata-list li {
      padding: 6px 0;
      font-size: 10pt;
      color: #475569;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #94a3b8;
      font-style: italic;
    }
  </style>
</head>
<body>

  <!-- PAGE 1: COVER -->
  <div class="page cover">
    <h1>DevOps Activity Report</h1>
    <div class="date-range"><%= dateRange %></div>
    <div class="metadata">
      <p><strong>Organization:</strong> <%= userSettings.name || userSettings.azureDevOpsOrg || 'N/A' %></p>
      <p><strong>Project:</strong> <%= userSettings.azureDevOpsProject || 'N/A' %></p>
      <p style="margin-top: 20px; font-size: 10pt;">Generated: <%= generatedAt %></p>
    </div>
    <div class="footer">Generated by InsightOps â€¢ https://insightops.dev</div>
  </div>

  <!-- PAGE 2: EXECUTIVE SUMMARY -->
  <div class="page">
    <h2 class="summary-header">Executive Summary</h2>
    
    <%
      // Calculate health score
      const totalBuilds = reportData.builds?.totalBuilds || 0;
      const buildSuccess = totalBuilds > 0 ? Math.round((reportData.builds.succeeded / totalBuilds) * 100) : 0;
      const totalPRs = reportData.pullRequests?.totalPRs || 0;
      const prCompletion = totalPRs > 0 ? Math.round((reportData.pullRequests.completed / totalPRs) * 100) : 0;
      const wiOverdue = reportData.workItems?.overdue || 0;
      const wiCreated = reportData.workItems?.created || 1;
      const overdueRate = Math.round((wiOverdue / wiCreated) * 100);
      
      let healthScore = 100;
      if (buildSuccess < 80) healthScore -= 20;
      if (buildSuccess < 60) healthScore -= 20;
      if (prCompletion < 70) healthScore -= 15;
      if (overdueRate > 20) healthScore -= 15;
      if (overdueRate > 40) healthScore -= 15;
      if (reportData.builds?.failed > 10) healthScore -= 10;
      
      healthScore = Math.max(0, healthScore);
      
      const healthColor = healthScore >= 80 ? '#16a34a' : healthScore >= 60 ? '#f97316' : '#dc2626';
    %>
    
    <div class="health-score">
      <div class="health-score-value" style="color: <%= healthColor %>"><%= healthScore %>/100</div>
      <div class="health-score-label">Overall Health Score</div>
    </div>
    
    <div class="highlights">
      <h3>âœ“ Key Highlights</h3>
      <ul>
        <% if (buildSuccess >= 80) { %>
          <li><strong><%= buildSuccess %>%</strong> build success rate â€” pipeline stability is strong</li>
        <% } %>
        <% if (reportData.pullRequests?.completed > 0) { %>
          <li><strong><%= reportData.pullRequests.completed %></strong> pull requests completed in this period</li>
        <% } %>
        <% if (reportData.workItems?.completed > 0) { %>
          <li><strong><%= reportData.workItems.completed %></strong> work items finished â€” good throughput</li>
        <% } %>
        <% if (reportData.releases?.succeeded > 0) { %>
          <li><strong><%= reportData.releases.succeeded %></strong> successful releases deployed</li>
        <% } %>
      </ul>
    </div>
    
    <div class="concerns">
      <h3>âš  Areas of Concern</h3>
      <ul>
        <% if (wiOverdue > 0) { %>
          <li><strong><%= wiOverdue %></strong> work items overdue â€” backlog risk detected</li>
        <% } %>
        <% if (reportData.builds?.failed > 5) { %>
          <li><strong><%= reportData.builds.failed %></strong> builds failed â€” investigate pipeline issues</li>
        <% } %>
        <% if (buildSuccess < 70) { %>
          <li>Build success rate at <strong><%= buildSuccess %>%</strong> â€” below healthy threshold</li>
        <% } %>
        <% if (reportData.prDiscussion?.unresolved > 10) { %>
          <li><strong><%= reportData.prDiscussion.unresolved %></strong> unresolved PR threads â€” review bottleneck</li>
        <% } %>
        <% if (reportData.pullRequests?.active > 20) { %>
          <li><strong><%= reportData.pullRequests.active %></strong> active PRs â€” potential merge delays</li>
        <% } %>
      </ul>
    </div>
  </div>

  <!-- PAGE 3: WORK ITEMS -->
  <% if (reportData.workItems) { %>
  <div class="page">
    <h2 class="section-header">ðŸ“‹ Work Items</h2>
    
    <div class="section-layout">
      <div class="section-main">
        <table class="metrics-table">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Created</td>
              <td><span class="metric-value neutral"><%= reportData.workItems.created || 0 %></span></td>
            </tr>
            <tr>
              <td>Completed</td>
              <td><span class="metric-value success"><%= reportData.workItems.completed || 0 %></span></td>
            </tr>
            <tr>
              <td>Overdue</td>
              <td><span class="metric-value danger"><%= reportData.workItems.overdue || 0 %></span></td>
            </tr>
          </tbody>
        </table>
        
        <div class="insights">
          <h4>Key Insights</h4>
          <ul>
            <% 
              const completionRate = reportData.workItems.created > 0 
                ? Math.round((reportData.workItems.completed / reportData.workItems.created) * 100) 
                : 0;
            %>
            <li><strong><%= completionRate %>%</strong> completion rate for work items in this period</li>
            <% if (reportData.workItems.overdue > 0) { %>
              <li><strong><%= reportData.workItems.overdue %></strong> items overdue â€” requires immediate attention</li>
            <% } else { %>
              <li>No overdue items â€” backlog is healthy</li>
            <% } %>
            <% if (reportData.workItems.stateDistribution) { %>
              <li>Top 5 states shown in distribution chart</li>
            <% } %>
          </ul>
        </div>
      </div>
      
      <% if (chartImages.workItems) { %>
      <div class="section-chart">
        <img src="<%= chartImages.workItems %>" alt="Work Items Distribution" />
        <p style="font-size: 9pt; color: #64748b; margin-top: 8px;">State Distribution</p>
      </div>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- PAGE 4: BUILDS -->
  <% if (reportData.builds) { %>
  <div class="page">
    <h2 class="section-header">ðŸ”¨ Builds</h2>
    
    <div class="section-layout">
      <div class="section-main">
        <table class="metrics-table">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total Builds</td>
              <td><span class="metric-value neutral"><%= reportData.builds.totalBuilds || 0 %></span></td>
            </tr>
            <tr>
              <td>Succeeded</td>
              <td><span class="metric-value success"><%= reportData.builds.succeeded || 0 %></span></td>
            </tr>
            <tr>
              <td>Failed</td>
              <td><span class="metric-value danger"><%= reportData.builds.failed || 0 %></span></td>
            </tr>
            <tr>
              <td>Others (Canceled/In Progress)</td>
              <td><span class="metric-value warning"><%= reportData.builds.others || 0 %></span></td>
            </tr>
          </tbody>
        </table>
        
        <div class="insights">
          <h4>Key Insights</h4>
          <ul>
            <% 
              const successRate = reportData.builds.totalBuilds > 0 
                ? Math.round((reportData.builds.succeeded / reportData.builds.totalBuilds) * 100) 
                : 0;
            %>
            <li><strong><%= successRate %>%</strong> success rate across all builds</li>
            <% if (reportData.builds.avgDuration) { %>
              <li>Average build duration: <strong><%= reportData.builds.avgDuration %></strong></li>
            <% } %>
            <% if (reportData.builds.failed > 5) { %>
              <li><strong><%= reportData.builds.failed %></strong> failed builds â€” investigate root causes</li>
            <% } else { %>
              <li>Build failures are minimal â€” pipeline is stable</li>
            <% } %>
          </ul>
        </div>
      </div>
      
      <% if (chartImages.builds) { %>
      <div class="section-chart">
        <img src="<%= chartImages.builds %>" alt="Build Status Distribution" />
        <p style="font-size: 9pt; color: #64748b; margin-top: 8px;">Status Distribution</p>
      </div>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- PAGE 5: RELEASES -->
  <% if (reportData.releases) { %>
  <div class="page">
    <h2 class="section-header">ðŸš€ Releases</h2>
    
    <div class="section-layout">
      <div class="section-main">
        <table class="metrics-table">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total Releases</td>
              <td><span class="metric-value neutral"><%= reportData.releases.totalReleases || 0 %></span></td>
            </tr>
            <tr>
              <td>Succeeded</td>
              <td><span class="metric-value success"><%= reportData.releases.succeeded || 0 %></span></td>
            </tr>
            <tr>
              <td>Failed</td>
              <td><span class="metric-value danger"><%= reportData.releases.failed || 0 %></span></td>
            </tr>
            <tr>
              <td>Others</td>
              <td><span class="metric-value warning"><%= reportData.releases.others || 0 %></span></td>
            </tr>
          </tbody>
        </table>
        
        <div class="insights">
          <h4>Key Insights</h4>
          <ul>
            <% 
              const releaseSuccess = reportData.releases.totalReleases > 0 
                ? Math.round((reportData.releases.succeeded / reportData.releases.totalReleases) * 100) 
                : 0;
            %>
            <li><strong><%= releaseSuccess %>%</strong> deployment success rate</li>
            <% if (reportData.releases.failed > 0) { %>
              <li><strong><%= reportData.releases.failed %></strong> failed deployments â€” review release process</li>
            <% } else { %>
              <li>All deployments successful â€” release pipeline is reliable</li>
            <% } %>
            <li>Total of <strong><%= reportData.releases.totalReleases %></strong> release activities in this period</li>
          </ul>
        </div>
      </div>
      
      <% if (chartImages.releases) { %>
      <div class="section-chart">
        <img src="<%= chartImages.releases %>" alt="Release Status" />
        <p style="font-size: 9pt; color: #64748b; margin-top: 8px;">Status Breakdown</p>
      </div>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- PAGE 6: PULL REQUESTS -->
  <% if (reportData.pullRequests) { %>
  <div class="page">
    <h2 class="section-header">ðŸ”€ Pull Requests</h2>
    
    <div class="section-layout">
      <div class="section-main">
        <table class="metrics-table">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total PRs</td>
              <td><span class="metric-value neutral"><%= reportData.pullRequests.totalPRs || 0 %></span></td>
            </tr>
            <tr>
              <td>Active</td>
              <td><span class="metric-value info"><%= reportData.pullRequests.active || 0 %></span></td>
            </tr>
            <tr>
              <td>Completed</td>
              <td><span class="metric-value success"><%= reportData.pullRequests.completed || 0 %></span></td>
            </tr>
            <tr>
              <td>Abandoned</td>
              <td><span class="metric-value neutral"><%= reportData.pullRequests.abandoned || 0 %></span></td>
            </tr>
          </tbody>
        </table>
        
        <div class="insights">
          <h4>Key Insights</h4>
          <ul>
            <% 
              const prCompletionRate = reportData.pullRequests.totalPRs > 0 
                ? Math.round((reportData.pullRequests.completed / reportData.pullRequests.totalPRs) * 100) 
                : 0;
            %>
            <li><strong><%= prCompletionRate %>%</strong> of PRs completed in this period</li>
            <% if (reportData.pullRequests.avgTimeToComplete) { %>
              <li>Average time to complete: <strong><%= reportData.pullRequests.avgTimeToComplete %>h</strong></li>
            <% } %>
            <% if (reportData.pullRequests.active > 20) { %>
              <li><strong><%= reportData.pullRequests.active %></strong> active PRs â€” potential review bottleneck</li>
            <% } else { %>
              <li>Active PR count is manageable</li>
            <% } %>
          </ul>
        </div>
      </div>
      
      <% if (chartImages.pullRequests) { %>
      <div class="section-chart">
        <img src="<%= chartImages.pullRequests %>" alt="PR Status" />
        <p style="font-size: 9pt; color: #64748b; margin-top: 8px;">Status Breakdown</p>
      </div>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- PAGE 7: PR COMMENTS & THREADS -->
  <% if (reportData.prDiscussion) { %>
  <div class="page">
    <h2 class="section-header">ðŸ’¬ PR Comments & Threads</h2>
    
    <div class="section-layout">
      <div class="section-main">
        <table class="metrics-table">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total Threads</td>
              <td><span class="metric-value neutral"><%= reportData.prDiscussion.totalThreads || 0 %></span></td>
            </tr>
            <tr>
              <td>Resolved</td>
              <td><span class="metric-value success"><%= reportData.prDiscussion.resolved || 0 %></span></td>
            </tr>
            <tr>
              <td>Unresolved</td>
              <td><span class="metric-value warning"><%= reportData.prDiscussion.unresolved || 0 %></span></td>
            </tr>
            <tr>
              <td>PRs Needing Review</td>
              <td><span class="metric-value warning"><%= reportData.prDiscussion.prsNeedReview || 0 %></span></td>
            </tr>
          </tbody>
        </table>
        
        <div class="insights">
          <h4>Key Insights</h4>
          <ul>
            <% 
              const resolutionRate = reportData.prDiscussion.totalThreads > 0 
                ? Math.round((reportData.prDiscussion.resolved / reportData.prDiscussion.totalThreads) * 100) 
                : 0;
            %>
            <li><strong><%= resolutionRate %>%</strong> thread resolution rate</li>
            <% if (reportData.prDiscussion.unresolved > 10) { %>
              <li><strong><%= reportData.prDiscussion.unresolved %></strong> unresolved threads â€” review process may be slow</li>
            <% } else { %>
              <li>Thread resolution is healthy</li>
            <% } %>
            <% if (reportData.prDiscussion.totalComments) { %>
              <li>Total comments: <strong><%= reportData.prDiscussion.totalComments %></strong></li>
            <% } %>
          </ul>
        </div>
      </div>
      
      <% if (chartImages.prDiscussion) { %>
      <div class="section-chart">
        <img src="<%= chartImages.prDiscussion %>" alt="Thread Resolution" />
        <p style="font-size: 9pt; color: #64748b; margin-top: 8px;">Resolution Status</p>
      </div>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- FINAL PAGE: METADATA -->
  <div class="page">
    <h2 class="summary-header">Report Metadata</h2>
    
    <div class="metadata-section">
      <h3>Generation Details</h3>
      <ul class="metadata-list">
        <li><strong>Generated:</strong> <%= generatedAt %></li>
        <li><strong>Date Range:</strong> <%= dateRange %></li>
        <li><strong>Organization:</strong> <%= userSettings.name || userSettings.azureDevOpsOrg || 'N/A' %></li>
        <li><strong>Project:</strong> <%= userSettings.azureDevOpsProject || 'N/A' %></li>
      </ul>
    </div>

    <div class="metadata-section">
      <h3>Glossary</h3>
      <ul class="metadata-list">
        <li><strong>PR:</strong> Pull Request â€” code review and merge workflow</li>
        <li><strong>WI:</strong> Work Item â€” task, bug, or user story</li>
        <li><strong>Success Rate:</strong> Percentage of succeeded builds or releases</li>
        <li><strong>Others:</strong> Builds/Releases that are canceled, in progress, or partially succeeded</li>
        <li><strong>Thread:</strong> Discussion thread in pull request comments</li>
        <li><strong>Overdue:</strong> Work items past their due date</li>
      </ul>
    </div>

    <div style="margin-top: 60px; text-align: center; color: #94a3b8; font-size: 10pt;">
      <p><strong>Generated by InsightOps v1.0</strong></p>
      <p>https://insightops.dev</p>
    </div>
  </div>

</body>
</html>
