<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DevOps Activity Report</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      color: #1e293b; 
      line-height: 1.5;
      font-size: 11pt;
    }
    
    .page { 
      page-break-after: always; 
      padding: 50px 60px;
      min-height: 100vh;
      page-break-inside: avoid;
    }
    .page:last-child { page-break-after: auto; }
    
    /* Typography System */
    .page-title { font-size: 24pt; font-weight: 700; }
    .section-header {
      font-size: 18pt;
      font-weight: 600;
      margin-bottom: 24px;
      color: #0f172a;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 10px;
      page-break-after: avoid;
    }
    .kpi-value { font-size: 20pt; font-weight: 700; }
    .kpi-label { font-size: 10pt; font-weight: 400; color: #64748b; }
    .body-text { font-size: 11pt; line-height: 1.5; }
    .caption { font-size: 9pt; color: #64748b; }
    
    /* Spacing Rhythm */
    .section-spacing { margin-bottom: 24px; }
    .element-spacing { margin-bottom: 12px; }
    
    /* Cover Page */
    .cover { 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      text-align: center;
      padding: 100px 60px;
    }
    .cover h1 { 
      font-size: 28pt; 
      font-weight: 700; 
      margin-bottom: 30px;
      color: #0f172a;
    }
    .cover .date-range { 
      font-size: 18pt; 
      color: #3b82f6; 
      font-weight: 600;
      margin-bottom: 60px;
      padding: 12px 24px;
      border: 2px solid #3b82f6;
      border-radius: 8px;
      display: inline-block;
    }
    .cover .metadata { 
      font-size: 12pt; 
      color: #64748b; 
      line-height: 1.8;
    }
    .cover .footer { 
      position: absolute; 
      bottom: 40px; 
      font-size: 10pt; 
      color: #94a3b8;
    }
    
    /* Executive Summary */
    .summary-header {
      font-size: 22pt;
      font-weight: 700;
      margin-bottom: 30px;
      color: #0f172a;
      border-bottom: 3px solid #e2e8f0;
      padding-bottom: 12px;
      page-break-after: avoid;
    }
    
    .health-score {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
    }
    .health-score-value {
      font-size: 48pt;
      font-weight: 700;
      color: #16a34a;
    }
    .health-score-label {
      font-size: 12pt;
      color: #64748b;
      margin-top: 8px;
    }
    
    .highlights, .concerns {
      margin: 25px 0;
      padding: 16px;
      border-radius: 6px;
      page-break-inside: avoid;
    }
    .highlights { background: #f8fafc; }
    .concerns { background: #fef2f2; }
    
    .highlights h3, .concerns h3 {
      font-size: 13pt;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .highlights h3 { color: #16a34a; }
    .concerns h3 { color: #dc2626; }
    
    .highlights ul, .concerns ul {
      list-style: none;
      padding: 0;
    }
    .highlights li, .concerns li {
      padding: 6px 0 6px 20px;
      position: relative;
      font-size: 11pt;
      line-height: 1.6;
    }
    .highlights li:before {
      content: "•";
      position: absolute;
      left: 0;
      color: #16a34a;
      font-weight: bold;
      font-size: 14pt;
    }
    .concerns li:before {
      content: "•";
      position: absolute;
      left: 0;
      color: #dc2626;
      font-weight: bold;
      font-size: 14pt;
    }
    
    /* Section Pages */
    .section-header {
      font-size: 18pt;
      font-weight: 600;
      margin-bottom: 24px;
      color: #0f172a;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 10px;
      page-break-after: avoid;
    }
    
    .section-layout {
      display: flex;
      gap: 30px;
      margin-bottom: 30px;
    }
    .section-main {
      flex: 2;
    }
    .section-chart {
      flex: 1;
      text-align: center;
    }
    .section-chart img {
      max-width: 100%;
      width: 100%;
      height: auto;
      max-height: 400px;
      display: block;
      margin: 0 auto;
    }
    .chart-caption {
      font-size: 9pt;
      color: #64748b;
      margin-top: 8px;
      font-style: italic;
    }
    
    /* Metrics Table */
    .metrics-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .metrics-table th {
      background: #f1f5f9;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 10pt;
      color: #475569;
      border: 1px solid #e2e8f0;
    }
    .metrics-table td {
      padding: 12px;
      border: 1px solid #e2e8f0;
      font-size: 11pt;
    }
    .metrics-table .metric-value {
      font-size: 22pt;
      font-weight: 700;
    }
    
    /* Insights Block */
    .insights {
      background: #f8fafc;
      padding: 16px;
      border-radius: 6px;
      margin-top: 20px;
      page-break-inside: avoid;
    }
    .insights h4 {
      font-size: 12pt;
      font-weight: 600;
      margin-bottom: 12px;
      color: #0f172a;
    }
    .insights ul {
      list-style: none;
      padding: 0;
    }
    .insights li {
      padding: 6px 0 6px 20px;
      position: relative;
      font-size: 10pt;
      line-height: 1.6;
      color: #475569;
    }
    .insights li:before {
      content: "•";
      position: absolute;
      left: 0;
      color: #3b82f6;
      font-weight: bold;
    }
    
    /* Semantic Colors */
    .success { color: #16a34a; }
    .danger { color: #dc2626; }
    .warning { color: #f97316; }
    .info { color: #3b82f6; }
    .neutral { color: #64748b; }
    
    /* Metadata Page */
    .metadata-section {
      margin-bottom: 30px;
    }
    .metadata-section h3 {
      font-size: 14pt;
      font-weight: 600;
      margin-bottom: 12px;
      color: #0f172a;
    }
    .metadata-list {
      list-style: none;
      padding: 0;
    }
    .metadata-list li {
      padding: 6px 0;
      font-size: 10pt;
      color: #475569;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 40px;
      color: #64748b;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px dashed #cbd5e1;
    }
    .empty-state p {
      font-size: 11pt;
      line-height: 1.6;
    }
  </style>
</head>
<body>

  <!-- PAGE 1: COVER -->
  <div class="page cover">
    <h1>DevOps Activity Report</h1>
    <div class="date-range"><%= dateRange %></div>
    <div class="metadata">
      <p><strong>Organization:</strong> <%= userSettings.azureDevOpsOrg || 'Not specified' %></p>
      <p><strong>Project:</strong> <%= userSettings.azureDevOpsProject || 'Not specified' %></p>
      <p style="margin-top: 20px; font-size: 10pt;">Generated: <%= generatedAt %></p>
    </div>
    <div class="footer">Generated by InsightOps</div>
  </div>

  <!-- PAGE 2: BUILD PERFORMANCE -->
  <% if (reportData.builds?.hasSufficientData) { %>
  <div class="page">
    <h2 class="section-header">Build Performance</h2>
    
    <div class="section-layout">
      <div class="section-main">
        <table class="metrics-table">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total Builds</td>
              <td><span class="metric-value neutral"><%= reportData.builds.totalBuilds || 0 %></span></td>
            </tr>
            <tr>
              <td>Succeeded</td>
              <td><span class="metric-value success"><%= reportData.builds.succeeded || 0 %></span></td>
            </tr>
            <tr>
              <td>Failed</td>
              <td><span class="metric-value danger"><%= reportData.builds.failed || 0 %></span></td>
            </tr>
            <tr>
              <td>Others (Canceled/In Progress)</td>
              <td><span class="metric-value warning"><%= reportData.builds.others || 0 %></span></td>
            </tr>
          </tbody>
        </table>
        
        <div class="insights">
          <h4>Key Insights</h4>
          <ul>
            <% 
              const successRate = reportData.builds.successRate;
            %>
            <% if (successRate !== null) { %>
              <li><strong><%= successRate %>%</strong> success rate across all builds</li>
            <% } %>
            <% if (reportData.builds.avgDuration) { %>
              <li>Average build duration: <strong><%= reportData.builds.avgDuration %></strong></li>
            <% } %>
            <% if (reportData.builds.failed > 5) { %>
              <li><strong><%= reportData.builds.failed %></strong> failed builds — investigate root causes</li>
            <% } else if (reportData.builds.failed > 0) { %>
              <li><strong><%= reportData.builds.failed %></strong> build failures detected</li>
            <% } else { %>
              <li>No build failures in this period — pipeline is stable</li>
            <% } %>
          </ul>
        </div>
      </div>
      
      <% if (chartImages.builds) { %>
      <div class="section-chart">
        <img src="<%= chartImages.builds %>" alt="Build Status Distribution" />
        <p class="chart-caption">Figure 1: Build status distribution</p>
      </div>
      <% } %>
    </div>
  </div>
  <% } else { %>
  <div class="page">
    <h2 class="section-header">Build Performance</h2>
    <div class="empty-state">
      <p>Insufficient data for meaningful analysis</p>
      <p style="font-size: 10pt; margin-top: 8px;">Minimum 5 builds required. Current: <%= reportData.builds?.totalBuilds || 0 %></p>
    </div>
  </div>
  <% } %>

  <!-- PAGE 5: RELEASES -->
  <% if (reportData.releases?.hasSufficientData) { %>
  <div class="page">
    <h2 class="section-header">Deployment Health</h2>
    
    <div class="section-layout">
      <div class="section-main">
        <table class="metrics-table">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total Releases</td>
              <td><span class="metric-value neutral"><%= reportData.releases.totalReleases || 0 %></span></td>
            </tr>
            <tr>
              <td>Succeeded</td>
              <td><span class="metric-value success"><%= reportData.releases.succeeded || 0 %></span></td>
            </tr>
            <tr>
              <td>Failed</td>
              <td><span class="metric-value danger"><%= reportData.releases.failed || 0 %></span></td>
            </tr>
            <tr>
              <td>Others</td>
              <td><span class="metric-value warning"><%= reportData.releases.others || 0 %></span></td>
            </tr>
          </tbody>
        </table>
        
        <div class="insights">
          <h4>Key Insights</h4>
          <ul>
            <% 
              const releaseSuccess = reportData.releases.successRate;
            %>
            <% if (releaseSuccess !== null) { %>
              <li><strong><%= releaseSuccess %>%</strong> deployment success rate</li>
            <% } else { %>
              <li>No release data available for success rate analysis</li>
            <% } %>
            <% if (reportData.releases.failed > 0) { %>
              <li><strong><%= reportData.releases.failed %></strong> failed deployments — review release process</li>
            <% } else if (reportData.releases.totalReleases > 0) { %>
              <li>All deployments successful — release pipeline is reliable</li>
            <% } %>
            <% if (reportData.releases.totalReleases > 0) { %>
              <li>Total of <strong><%= reportData.releases.totalReleases %></strong> release activities in this period</li>
            <% } %>
          </ul>
        </div>
      </div>
      
      <% if (chartImages.releases) { %>
      <div class="section-chart">
        <img src="<%= chartImages.releases %>" alt="Release Status" />
        <p class="chart-caption">Figure 2: Deployment status breakdown</p>
      </div>
      <% } %>
    </div>
  </div>
  <% } else { %>
  <div class="page">
    <h2 class="section-header">Deployment Health</h2>
    <div class="empty-state">
      <p>Insufficient data for meaningful analysis</p>
      <p style="font-size: 10pt; margin-top: 8px;">Minimum 5 releases required. Current: <%= reportData.releases?.totalReleases || 0 %></p>
    </div>
  </div>
  <% } %>

  <!-- PAGE 6: PULL REQUESTS -->
  <% if (reportData.pullRequests?.hasSufficientData) { %>
  <div class="page">
    <h2 class="section-header">Code Review Health</h2>
    
    <div class="section-layout">
      <div class="section-main">
        <table class="metrics-table">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total PRs</td>
              <td><span class="metric-value neutral"><%= reportData.pullRequests.totalPRs || 0 %></span></td>
            </tr>
            <tr>
              <td>Active</td>
              <td><span class="metric-value info"><%= reportData.pullRequests.active || 0 %></span></td>
            </tr>
            <tr>
              <td>Completed</td>
              <td><span class="metric-value success"><%= reportData.pullRequests.completed || 0 %></span></td>
            </tr>
            <tr>
              <td>Abandoned</td>
              <td><span class="metric-value neutral"><%= reportData.pullRequests.abandoned || 0 %></span></td>
            </tr>
          </tbody>
        </table>
        
        <div class="insights">
          <h4>Key Insights</h4>
          <ul>
            <% 
              const prCompletionRate = reportData.pullRequests.completionRate;
            %>
            <% if (prCompletionRate !== null) { %>
              <li><strong><%= prCompletionRate %>%</strong> of PRs completed in this period</li>
            <% } else { %>
              <li>No PR data available for completion rate analysis</li>
            <% } %>
            <% if (reportData.pullRequests.avgTimeToComplete) { %>
              <li>Average time to complete: <strong><%= reportData.pullRequests.avgTimeToComplete %>h</strong></li>
            <% } %>
            <% if (reportData.pullRequests.active > 20) { %>
              <li><strong><%= reportData.pullRequests.active %></strong> active PRs — potential review bottleneck</li>
            <% } else if (reportData.pullRequests.active > 0) { %>
              <li><strong><%= reportData.pullRequests.active %></strong> active PRs — manageable workload</li>
            <% } %>
          </ul>
        </div>
      </div>
      
      <% if (chartImages.pullRequests) { %>
      <div class="section-chart">
        <img src="<%= chartImages.pullRequests %>" alt="PR Status" />
        <p class="chart-caption">Figure 3: Pull request status distribution</p>
      </div>
      <% } %>
    </div>
  </div>
  <% } else { %>
  <div class="page">
    <h2 class="section-header">Code Review Health</h2>
    <div class="empty-state">
      <p>Insufficient data for meaningful analysis</p>
      <% if (reportData.pullRequests?.totalPRs > 0) { %>
        <p style="font-size: 10pt; margin-top: 8px;">
          Data quality issue: <%= reportData.pullRequests.totalPRs %> PRs reported but status breakdown unavailable.
          <br/>This may indicate an API data fetch issue.
        </p>
      <% } else { %>
        <p style="font-size: 10pt; margin-top: 8px;">
          Minimum 5 pull requests required. Current: <%= reportData.pullRequests?.totalPRs || 0 %>
        </p>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- PAGE 7: PR COMMENTS & THREADS -->
  <% if (reportData.prDiscussion?.hasSufficientData) { %>
  <div class="page">
    <h2 class="section-header">Discussion Health</h2>
    
    <div class="section-layout">
      <div class="section-main">
        <table class="metrics-table">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total Threads</td>
              <td><span class="metric-value neutral"><%= reportData.prDiscussion.totalThreads || 0 %></span></td>
            </tr>
            <tr>
              <td>Resolved</td>
              <td><span class="metric-value success"><%= reportData.prDiscussion.resolved || 0 %></span></td>
            </tr>
            <tr>
              <td>Unresolved</td>
              <td><span class="metric-value warning"><%= reportData.prDiscussion.unresolved || 0 %></span></td>
            </tr>
            <tr>
              <td>PRs Needing Review</td>
              <td><span class="metric-value warning"><%= reportData.prDiscussion.prsNeedReview || 0 %></span></td>
            </tr>
          </tbody>
        </table>
        
        <div class="insights">
          <h4>Key Insights</h4>
          <ul>
            <% 
              const resolutionRate = reportData.prDiscussion.resolutionRate;
            %>
            <% if (resolutionRate !== null) { %>
              <li><strong><%= resolutionRate %>%</strong> thread resolution rate</li>
            <% } else { %>
              <li>No discussion data available for resolution rate analysis</li>
            <% } %>
            <% if (reportData.prDiscussion.unresolved > 10) { %>
              <li><strong><%= reportData.prDiscussion.unresolved %></strong> unresolved threads — review process may be slow</li>
            <% } else if (reportData.prDiscussion.unresolved > 0) { %>
              <li><strong><%= reportData.prDiscussion.unresolved %></strong> unresolved threads — within normal range</li>
            <% } else { %>
              <li>All discussion threads resolved</li>
            <% } %>
            <% if (reportData.prDiscussion.totalComments) { %>
              <li>Total comments: <strong><%= reportData.prDiscussion.totalComments %></strong></li>
            <% } %>
          </ul>
        </div>
      </div>
      
      <% if (chartImages.prDiscussion) { %>
      <div class="section-chart">
        <img src="<%= chartImages.prDiscussion %>" alt="Thread Resolution" />
        <p class="chart-caption">Figure 4: Discussion thread resolution status</p>
      </div>
      <% } %>
    </div>
  </div>
  <% } else { %>
  <div class="page">
    <h2 class="section-header">Discussion Health</h2>
    <div class="empty-state">
      <p>Insufficient data for meaningful analysis</p>
      <% if (reportData.prDiscussion?.totalThreads > 0) { %>
        <p style="font-size: 10pt; margin-top: 8px;">
          Data quality issue: <%= reportData.prDiscussion.totalThreads %> threads reported but resolution status unavailable.
          <br/>This may indicate an API data fetch issue.
        </p>
      <% } else { %>
        <p style="font-size: 10pt; margin-top: 8px;">
          Minimum 5 discussion threads required. Current: <%= reportData.prDiscussion?.totalThreads || 0 %>
        </p>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- FINAL PAGE: METADATA -->
  <div class="page">
    <h2 class="summary-header">Report Metadata</h2>
    
    <div class="metadata-section">
      <h3>Generation Details</h3>
      <ul class="metadata-list">
        <li><strong>Generated:</strong> <%= generatedAt %></li>
        <li><strong>Date Range:</strong> <%= dateRange %></li>
        <li><strong>Organization:</strong> <%= userSettings.azureDevOpsOrg || 'Not specified' %></li>
        <li><strong>Project:</strong> <%= userSettings.azureDevOpsProject || 'Not specified' %></li>
      </ul>
    </div>

    <div class="metadata-section">
      <h3>Glossary</h3>
      <ul class="metadata-list">
        <li><strong>PR:</strong> Pull Request — code review and merge workflow</li>
        <li><strong>WI:</strong> Work Item — task, bug, or user story</li>
        <li><strong>Success Rate:</strong> Percentage of succeeded builds or releases</li>
        <li><strong>Others:</strong> Builds/Releases that are canceled, in progress, or partially succeeded</li>
        <li><strong>Thread:</strong> Discussion thread in pull request comments</li>
        <li><strong>Overdue:</strong> Work items past their due date</li>
      </ul>
    </div>

    <div style="margin-top: 60px; text-align: center; color: #94a3b8; font-size: 10pt;">
      <p><strong>Generated by InsightOps</strong></p>
    </div>
  </div>

</body>
</html>
